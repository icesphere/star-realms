<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:sr="http://java.sun.com/jsf/composite/components">

<ui:composition template="/templates/commonLayout.xhtml">

    <ui:define name="head">
        <h:outputStylesheet name="game.css" library="css" />

        <script>
            $( document ).ready(function() {
                setTimeout(scrollChat, 500);
            });

            function scrollChat () {
                var chats = $('#chats');
                chats.scrollTop(chats.prop('scrollHeight'));
            }
        </script>
    </ui:define>

    <ui:define name="content">
        <h:form name="gameForm" id="gameForm">

            <p:remoteCommand name="updateCardView" actionListener="#{gameView.updateCardView}" update="cardViewSection"/>

            <p:remoteCommand name="cardClicked" actionListener="#{gameView.cardClicked}"/>

            <p:remoteCommand name="refreshGamePage" process="@this" update="gamePage"/>
            <p:remoteCommand name="refreshLeftSection" process="@this" update="leftSection"/>
            <p:remoteCommand name="refreshMiddleSection" process="@this" update="middleSection"/>
            <p:remoteCommand name="refreshRightSection" process="@this" update="rightSection"/>
            <p:remoteCommand name="refreshGameLog" process="@this" update="gameLogSection"/>
            <p:remoteCommand name="refreshHand" process="@this" update="handSection"/>
            <p:remoteCommand name="refreshPlayArea" process="@this" update="playAreaSection"/>
            <p:remoteCommand name="refreshPlayerInfo" process="@this" update="playerInfoSection"/>
            <p:remoteCommand name="refreshTurnInfo" process="@this" update="turnInfoSection"/>
            <p:remoteCommand name="refreshTurnButtons" process="@this" update="turnButtonsSection"/>
            <p:remoteCommand name="refreshTradeRow" process="@this" update="tradeRowSection"/>
            <p:remoteCommand name="refreshDeployedSection" process="@this" update="deployedSection"/>
            <p:remoteCommand name="refreshChat" process="@this" update="chatSection" oncomplete="scrollChat()"/>

            <div class="gamePagePlusChat">

                <h:panelGroup layout="block" id="gamePage" styleClass="gamePage">

                    <h:panelGroup layout="block" id="leftSection" styleClass="leftSection">

                        <h:panelGroup layout="block" id="tradeRowSection" styleClass="tradeRowSection">

                            <div style="float: left;">
                                <h:outputText value="Trade row" style="font-weight: bold;"/>
                            </div>

                            <div class="tradeRow" style="padding-top: 10px;">
                                <sr:tradeRowCard card="#{gameView.game.explorer}" source="explorers"/>
                                <ui:repeat value="#{gameView.game.tradeRow}" var="card">
                                    <sr:tradeRowCard card="#{card}" source="tradeRow"/>
                                </ui:repeat>
                            </div>

                        </h:panelGroup>

                        <h:panelGroup layout="block" id="cardViewSection">
                            <h:panelGroup layout="block" styleClass="cardViewSection">
                                <h:panelGroup>
                                    <div class="cardView">
                                        <h:panelGroup layout="block" rendered="#{!empty gameView.cardToView}">
                                            <h:outputText value="#{gameView.cardToView.name}" style="font-weight: bold; font-size: 20px;"/>
                                            <div style="padding-top: 15px; font-size: 18px;">
                                                <h:outputText value="#{gameView.getFactionDisplayName(gameView.cardToView)}"/>
                                            </div>
                                            <h:panelGroup rendered="#{!gameView.cardToView.gambit}">
                                                <div style="padding-top: 15px;">
                                                    <h:outputText value="Cost:" style="padding-right: 10px;"/>
                                                    <h:outputText value="$#{gameView.cardToView.cost}"/>
                                                </div>
                                            </h:panelGroup>
                                            <h:panelGroup layout="block" rendered="#{gameView.cardToView.base}" style="padding-top: 15px;">
                                                <h:outputText value="#{gameView.cardToView.shield} Defense"/>
                                                <h:outputText value="(Outpost)" style="padding-left: 10px;" rendered="#{gameView.cardToView.outpost}"/>
                                            </h:panelGroup>
                                            <div style="padding-top: 15px;">
                                                <h:outputText value="#{gameView.cardToView.text}"/>
                                            </div>
                                        </h:panelGroup>
                                        <h:panelGroup layout="block" rendered="#{empty gameView.cardToView}" styleClass="emptyCardView">
                                            Hover over a card to see card details.
                                        </h:panelGroup>
                                    </div>
                                </h:panelGroup>
                            </h:panelGroup>
                        </h:panelGroup>

                    </h:panelGroup>

                    <h:panelGroup layout="block" id="middleSection" styleClass="middleSection">

                        <h:panelGroup layout="block" id="playerInfoSection" styleClass="playerInfoSection">

                            <sr:playerInfo player="#{gameView.player}" playerClass="player" isOpponent="false"/>

                            <sr:playerInfo player="#{gameView.opponent}" playerClass="opponent" isOpponent="true"/>

                        </h:panelGroup>

                        <h:panelGroup layout="block" id="showCardsSection" styleClass="showCardsSection" rendered="#{gameView.showingCards}">

                            <div>
                                <h:outputText value="#{gameView.showingCardsTitle}" style="font-weight: bold"/>
                            </div>

                            <div style="float: left; padding-top: 10px;">

                                <ui:repeat value="#{gameView.cardsToShow}" var="card">
                                    <sr:card card="#{card}" source="#{gameView.cardsToShowSource}"/>
                                </ui:repeat>

                            </div>

                            <div style="clear: both; padding-top: 10px;">

                                <p:commandLink value="Hide" process="@this" update="middleSection" styleClass="smallButton"
                                               actionListener="#{gameView.hideCardsToShow}"/>

                            </div>

                        </h:panelGroup>

                        <h:panelGroup layout="block" id="turnInfoSection" styleClass="turnInfoSection" rendered="#{!gameView.game.gameOver}">
                            <div style="float: left;">
                                <div style="padding-top: 5px;">
                                    <h:outputText styleClass="currentPlayerTurnText #{gameView.player.yourTurn ? 'player' : 'opponent'}" value="#{gameView.game.currentPlayer.playerName}'s Turn"/>
                                    <h:outputText value="Trade: #{gameView.game.currentPlayer.trade}" styleClass="tradeAmount"/>
                                    <h:outputText value="Combat: #{gameView.game.currentPlayer.combat}" styleClass="combatAmount"/>
                                </div>
                            </div>
                        </h:panelGroup>

                        <h:panelGroup layout="block" id="actionSection" styleClass="actionSection"
                                      rendered="#{gameView.player.yourTurn and !empty gameView.action}">

                            <div style="float: left;">
                                <h:outputText value="Current Action" styleClass="currentActionLabel"/>
                            </div>

                            <div style="clear: both; float: left; padding-top: 10px;">
                                <h:outputText value="#{gameView.action.text}" />
                            </div>

                            <h:panelGroup rendered="#{!empty gameView.action.choices}">
                                <div style="clear: both; float: left; padding-top: 10px;">
                                    <ui:repeat value="#{gameView.action.choices}" var="choice">
                                        <p:commandLink value="#{choice.text}" style="margin-right: 10px;" styleClass="smallButton"
                                                         actionListener="#{gameView.choiceMade(choice.choiceNumber)}"/>
                                    </ui:repeat>
                                </div>
                            </h:panelGroup>

                            <h:panelGroup rendered="#{gameView.action.showDone or gameView.action.showDoNotUse}">

                                <div style="clear: both; float: left; padding-top: 10px;">

                                    <p:commandLink value="Do not use" style="margin-right: 15px;" styleClass="smallButton"
                                                   rendered="#{gameView.action.showDoNotUse}"
                                                   actionListener="#{gameView.doNotUseAction}"/>

                                    <p:commandLink value="#{gameView.action.doneText}" styleClass="smallButton"
                                                   rendered="#{gameView.action.showDone}"
                                                   actionListener="#{gameView.doneWithAction}"/>
                                </div>

                            </h:panelGroup>

                        </h:panelGroup>

                        <div style="clear: left; float: left; padding-top: 20px;">

                            <h:panelGroup layout="block" id="handSection" styleClass="handSection">
                                <span style="font-style: italic;">Your Hand:</span>
                                <div class="hand">
                                    <ui:repeat value="#{gameView.player.hand}" var="card">
                                        <sr:card card="#{card}" source="hand"/>
                                    </ui:repeat>
                                </div>
                            </h:panelGroup>

                            <h:panelGroup layout="block" id="playAreaSection" styleClass="playAreaSection">
                                <span style="font-style: italic;">Play Area:</span>
                                <div class="playArea">
                                    <ui:repeat value="#{gameView.cardsForPlayArea}" var="card">
                                        <sr:card card="#{card}" source="playArea"/>
                                    </ui:repeat>
                                </div>
                            </h:panelGroup>

                        </div>

                        <h:panelGroup layout="block" id="deployedSection" styleClass="deployedSection">

                            <h:panelGroup layout="block" id="playerDeployedSection" styleClass="playerDeployedSection player">
                                <div style="float: left">
                                    <h:outputText value="#{gameView.player.playerName}"/>
                                </div>

                                <h:panelGroup rendered="#{!empty gameView.player.bases}">
                                    <div style="clear: both; float: left; padding-top: 10px;">
                                        <div>
                                            <h:outputText value="Bases"/>
                                        </div>
                                        <div style="clear: both; float:left; padding-top: 5px;">
                                            <ui:repeat value="#{gameView.player.bases}" var="card">
                                                <sr:card card="#{card}" source="playerBases"/>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </h:panelGroup>

                                <h:panelGroup rendered="#{!empty gameView.player.heroes}">
                                    <div style="clear: both; float: left; padding-top: 10px;">
                                        <div>
                                            <h:outputText value="Heroes"/>
                                        </div>
                                        <div style="clear: both; float:left; padding-top: 5px;">
                                            <ui:repeat value="#{gameView.player.heroes}" var="card">
                                                <sr:card card="#{card}" source="playerHeroes"/>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </h:panelGroup>

                                <h:panelGroup rendered="#{!empty gameView.player.gambits}">
                                    <div style="clear: both; float: left; padding-top: 10px;">
                                        <div>
                                            <h:outputText value="Gambits"/>
                                        </div>
                                        <div style="clear: both; float:left; padding-top: 5px;">
                                            <ui:repeat value="#{gameView.player.gambits}" var="card">
                                                <sr:card card="#{card}" source="playerGambits"/>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </h:panelGroup>
                            </h:panelGroup>

                            <h:panelGroup layout="block" id="opponentDeployedSection" styleClass="opponentDeployedSection opponent">
                                <div style="float: left">
                                    <h:outputText value="#{gameView.player.opponent.playerName}"/>
                                </div>

                                <h:panelGroup rendered="#{!empty gameView.player.opponent.bases}">
                                    <div style="clear: both; float: left; padding-top: 10px;">
                                        <div>
                                            <h:outputText value="Bases"/>
                                        </div>
                                        <div style="clear: both; float:left; padding-top: 5px;">
                                            <ui:repeat value="#{gameView.player.opponent.bases}" var="card">
                                                <sr:card card="#{card}" source="opponentBases"/>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </h:panelGroup>

                                <h:panelGroup rendered="#{!empty gameView.player.opponent.heroes}">
                                    <div style="clear: both; float: left; padding-top: 10px;">
                                        <div>
                                            <h:outputText value="Heroes"/>
                                        </div>
                                        <div style="clear: both; float:left; padding-top: 5px;">
                                            <ui:repeat value="#{gameView.player.opponent.heroes}" var="card">
                                                <sr:card card="#{card}" source="opponentHeroes"/>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </h:panelGroup>

                                <h:panelGroup rendered="#{!empty gameView.player.opponent.gambits}">
                                    <div style="clear: both; float: left; padding-top: 10px;">
                                        <div>
                                            <h:outputText value="Gambits"/>
                                        </div>
                                        <div style="clear: both; float:left; padding-top: 5px;">
                                            <ui:repeat value="#{gameView.player.opponent.gambits}" var="card">
                                                <sr:card card="#{card}" source="opponentGambits"/>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </h:panelGroup>
                            </h:panelGroup>

                        </h:panelGroup>

                    </h:panelGroup>

                    <h:panelGroup layout="block" id="rightSection" styleClass="rightSection">

                        <sr:lastTurnSummary player="#{gameView.opponent}" playerClass="opponent" isOpponent="true"/>

                        <sr:lastTurnSummary player="#{gameView.player}" playerClass="player" isOpponent="false"/>

                        <h:panelGroup layout="block" rendered="#{!gameView.game.gameOver}" id="turnButtonsSection" styleClass="turnButtonsSection">

                            <h:panelGroup rendered="#{gameView.player.yourTurn and empty gameView.action}">

                                <h:panelGroup layout="block" styleClass="turnButtonWrapper" rendered="#{!empty gameView.player.hand}">
                                    <sr:linkWithSpinner process="@this" update=":gameForm:gamePage" styleClass="turnButton"
                                                        linkText="PLAY ALL" actionMethod="#{gameView.playAll}"/>
                                </h:panelGroup>

                                <h:panelGroup layout="block" styleClass="turnButtonWrapper">
                                    <sr:linkWithSpinner process="@this" update=":gameForm:gamePage" styleClass="turnButton"
                                                        linkText="END TURN" actionMethod="#{gameView.endTurn}"/>
                                </h:panelGroup>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="turnButtonWrapper">
                                <p:commandLink process="@this" styleClass="turnButton" value="QUIT GAME"
                                               onclick="if (!confirm('Are you sure you want to quit the game?')) return false"
                                               action="#{gameView.quitGame}"/>
                            </h:panelGroup>

                        </h:panelGroup>

                        <h:panelGroup layout="block" rendered="#{gameView.game.gameOver}" styleClass="gameOverSection">

                            <div style="padding-top: 10px;">
                                <h:outputText styleClass="turnPhaseText" value="GAME OVER"/>
                            </div>

                            <h:panelGroup layout="block" rendered="#{empty gameView.game.quitGamePlayer}">
                                <div style="padding-top: 15px">
                                    <h:outputText value="#{gameView.game.winner.playerName} WINS!"/>
                                </div>
                            </h:panelGroup>

                            <h:panelGroup layout="block" rendered="#{!empty gameView.game.quitGamePlayer}">
                                <div style="padding-top: 15px">
                                    <h:outputText value="#{gameView.game.quitGamePlayer.playerName} quit the game."/>
                                </div>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="turnButtonWrapper">
                                <p:commandLink ajax="false" styleClass="turnButton" value="GAME LOG">
                                    <p:fileDownload value="#{gameView.gameLog}" />
                                </p:commandLink>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="turnButtonWrapper">
                                <p:commandLink process="@this" styleClass="turnButton" value="EXIT GAME" action="#{gameView.exitGame}"/>
                            </h:panelGroup>

                        </h:panelGroup>

                    </h:panelGroup>

                    <h:panelGroup layout="block" id="farRightSection" styleClass="farRightSection">

                        <h:panelGroup layout="block" id="chatSection" styleClass="chatSection" style="#{gameView.opponent.bot ? 'display: none;' : ''}">
                            <div style="padding-bottom: 5px;">
                                <h:outputText value="Chat" styleClass="sectionHeader"/>
                            </div>
                            <div id="chats" class="chats">
                                <ui:repeat value="#{gameView.game.chatMessages}" var="chatMessage">
                                    <div style="padding-top: 10px;">
                                        <h:outputText value="#{chatMessage.username}:"
                                                      styleClass="#{gameView.player.playerName eq chatMessage.username ? 'player' : 'opponent'}"/>
                                        <h:outputText value="#{chatMessage.message}" style="padding-left: 10px;"/>
                                    </div>
                                </ui:repeat>
                            </div>
                            <div style="padding-top: 10px;">
                                <p:inputText value="#{gameView.chatMessage}" style="margin-right: 10px;"/>
                                <p:commandButton value="Send" process="chatSection" update="chatSection"
                                                 actionListener="#{gameView.sendChatMessage}" oncomplete="scrollChat()"/>
                            </div>
                        </h:panelGroup>

                        <h:panelGroup layout="block" id="gameLogSection" styleClass="gameLogSection" style="#{gameView.opponent.bot ? '' : 'clear: both; float: left; margin-top: 15px;'}">
                            <div style="padding-bottom: 5px;">
                                <h:outputText value="Game Log" styleClass="sectionHeader"/>
                            </div>
                            <div class="gameLog" style="#{gameView.opponent.bot ? 'height: 530px;' : ''}">
                                <h:outputText value="#{gameView.game.gameLog.toString()}" escape="false"/>
                            </div>
                        </h:panelGroup>

                    </h:panelGroup>

                </h:panelGroup>

            </div>

        </h:form>

        <p:socket onMessage="handleGameMessage" channel="/game/#{gameView.game.gameId}/#{userSession.user.username}" autoConnect="true" widgetVar='gameMessageSubscriber' />

        <script type="text/javascript">
            function handleGameMessage(response) {
                console.log("received message from server: ");
                console.log(response);

                var message = response.message;

                if (message == 'refresh_game_page') {
                    refreshGamePage();
                } else if (message == 'refresh_left_section') {
                    refreshLeftSection();
                } else if (message == 'refresh_middle_section') {
                    refreshMiddleSection();
                } else if (message == 'refresh_right_section') {
                    refreshRightSection();
                } else if (message == 'refresh_hand') {
                    refreshHand();
                } else if (message == 'refresh_play_area') {
                    refreshPlayArea();
                } else if (message == 'refresh_game_log') {
                    refreshGameLog();
                } else if (message == 'refresh_player_info') {
                    refreshPlayerInfo();
                } else if (message == 'refresh_turn_info') {
                    refreshTurnInfo();
                } else if (message == 'refresh_turn_buttons') {
                    refreshTurnButtons();
                } else if (message == 'refresh_trade_row') {
                    refreshTradeRow();
                } else if (message == 'refresh_deployed_section') {
                    refreshDeployedSection();
                } else if (message == 'refresh_chat') {
                    refreshChat();
                }
            }
        </script>
    </ui:define>

</ui:composition>
</html>