<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:sr="http://java.sun.com/jsf/composite/components">

<ui:composition template="/templates/commonLayout.xhtml">

    <ui:define name="head">
        <h:outputStylesheet name="game.css" library="css"/>

        <script>
            $(document).ready(function () {
                setTimeout(scrollChat, 500);
            });

            function scrollChat() {
                var chats = $('#chats');
                chats.scrollTop(chats.prop('scrollHeight'));
            }
        </script>
    </ui:define>

    <ui:define name="content">
        <h:form id="gameForm">

            <p:remoteCommand name="updateCardView" actionListener="#{gameView.updateCardView}"
                             update="cardViewSection"/>

            <p:remoteCommand name="updateCardViewWithMission" actionListener="#{gameView.updateCardViewWithMission}"
                             update="cardViewSection"/>

            <p:remoteCommand name="cardClicked" actionListener="#{gameView.cardClicked}"/>

            <p:remoteCommand name="refreshGamePage" process="@this" update="gamePagePlusOverlay"/>

            <p:remoteCommand name="refreshChat" process="@this" update="chatSection" oncomplete="scrollChat()"/>

            <h:panelGroup id="gamePagePlusChat" layout="block" styleClass="gamePagePlusChat">

                <h:panelGroup id="gamePagePlusOverlay" layout="block" styleClass="gamePage">

                    <h:panelGroup id="gamePageOverlay">
                        <h:panelGroup layout="block" rendered="#{gameView.game.gameOver}"
                                      styleClass="gamePageOverlay">

                            <h:panelGroup layout="block" styleClass="gamePageOverlayHeader">
                                <h:outputText style="display:block" value="GAME OVER"/>
                                <h:panelGroup layout="block" rendered="#{empty gameView.game.quitGamePlayer}">
                                    <h:outputText value="#{gameView.game.winner.playerName} wins!"/>
                                    <h:outputText style="display:block;text-decoration:underline;"
                                                  value="#{gameView.game.winner.playerName eq gameView.player.playerName ?
                                                           'Victory Achieved!' : 'Hideous defeat!'}"/>
                                </h:panelGroup>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="gamePageOverlayText"
                                          rendered="#{!empty gameView.game.quitGamePlayer}">
                                <h:outputText value="#{gameView.game.quitGamePlayer.playerName} quit the game."/>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="turnButtonWrapper"
                                          rendered="#{gameView.game.gameOver}">
                                <p:commandLink ajax="false" styleClass="turnButton" value="GAME LOG">
                                    <p:fileDownload value="#{gameView.gameLog}"/>
                                </p:commandLink>
                            </h:panelGroup>

                            <h:panelGroup layout="block" styleClass="turnButtonWrapper">
                                <p:commandLink process="@this" styleClass="quitButton"
                                               value="Quit Game" action="#{gameView.exitGame}"/>
                            </h:panelGroup>

                        </h:panelGroup>

                    </h:panelGroup>

                    <h:panelGroup layout="block" id="gamePage" styleClass="gamePageContent">

                        <h:panelGroup layout="block" id="leftSection" styleClass="leftSection">

                            <sr:playerInfo player="#{gameView.opponent}" id="opponentPlayerInfo" playerClass="opponent"
                                           isOpponent="true" isTheirTurn="#{!gameView.player.yourTurn}"/>

                            <h:panelGroup layout="block" id="supplySection" styleClass="supplySection">

                                <h:outputText value="Trade Row" styleClass="playerContentCardAreaText" style="left: -200px;" />

                                <h:panelGroup layout="block" class="tradeRow">
                                    <sr:card card="#{gameView.game.explorer}" source="explorers" tradeRow="true"/>
                                    <ui:repeat value="#{gameView.game.tradeRow}" var="card">
                                        <sr:card card="#{card}" source="tradeRow" tradeRow="true"/>
                                    </ui:repeat>
                                </h:panelGroup>

                            </h:panelGroup>

                            <sr:playerInfo player="#{gameView.player}" id="playerPlayerInfo" playerClass="player"
                                           isOpponent="false" isTheirTurn="#{gameView.player.yourTurn}"/>

                            <h:panelGroup layout="block" styleClass="actionSection"
                                          rendered="#{gameView.player.waitingForComputer}">

                                <div style="float: left;">
                                    <h:outputText value="Computer's Turn" styleClass="currentActionLabel"/>
                                </div>

                                <div style="clear: both; float: left; padding-top: 10px;">
                                    <h:outputText value="Waiting for computer..." style="padding-right: 10px;"/>

                                    <h:graphicImage id="loadingImage" library="images" name="loadingSmall.gif"/>
                                </div>

                            </h:panelGroup>

                            <h:panelGroup layout="block" id="actionSection" styleClass="actionSection"
                                          rendered="#{gameView.player.yourTurn and !empty gameView.action}">

                                <div style="float: left;">
                                    <h:outputText value="Current Action" styleClass="currentActionLabel"/>
                                </div>

                                <div style="clear: both; float: left; padding-top: 10px;">
                                    <h:outputText value="#{gameView.action.text}"/>
                                </div>

                                <h:panelGroup rendered="#{!empty gameView.action.choices}">
                                    <div style="clear: both; float: left; padding-top: 10px;">
                                        <ui:repeat value="#{gameView.action.choices}" var="choice">
                                            <p:commandLink value="#{choice.text}" style="margin-right: 10px;"
                                                           styleClass="smallButton"
                                                           actionListener="#{gameView.choiceMade(choice.choiceNumber)}"/>
                                        </ui:repeat>
                                    </div>
                                </h:panelGroup>

                                <h:panelGroup rendered="#{gameView.action.showDone or gameView.action.showDoNotUse}">

                                    <div style="clear: both; float: left; padding-top: 10px;">

                                        <p:commandLink value="Do not use" style="margin-right: 15px;"
                                                       styleClass="smallButton"
                                                       rendered="#{gameView.action.showDoNotUse}"
                                                       actionListener="#{gameView.doNotUseAction}"/>

                                        <p:commandLink value="#{gameView.action.doneText}" styleClass="smallButton"
                                                       rendered="#{gameView.action.showDone}"
                                                       actionListener="#{gameView.doneWithAction}"/>
                                    </div>

                                </h:panelGroup>

                            </h:panelGroup>

                            <h:panelGroup layout="block" id="handSection" styleClass="handSection">
                                <h:outputText value="Your Hand" styleClass="playerContentCardAreaText"/>
                                <h:panelGroup layout="block" styleClass="handCards">
                                    <ui:repeat value="#{gameView.player.hand}" var="card">
                                        <sr:card card="#{card}" source="hand"/>
                                    </ui:repeat>
                                </h:panelGroup>

                                <h:panelGroup rendered="#{gameView.player.yourTurn and !empty gameView.player.hand and empty gameView.action}">
                                    <sr:linkWithSpinner process="@this" update=":gameForm:gamePage"
                                                        styleClass="playAllButton"
                                                        linkText="Play All" actionMethod="#{gameView.playAll}"/>
                                </h:panelGroup>

                                <h:panelGroup styleClass="playerContentCardAreaBuffer"/>
                            </h:panelGroup>

                            <div style="padding-bottom: 20px;">
                                <h:panelGroup layout="block" id="gameLogSection" styleClass="gameLogSection">
                                    <h:outputText value="Game Log" styleClass="playerContentCardAreaText"/>
                                    <h:outputText styleClass="gameLog" value="#{gameView.game.gameLog.toString()}"
                                                  escape="false"/>
                                </h:panelGroup>
                            </div>

                            <h:panelGroup layout="block" styleClass="rightSection">

                                <sr:lastTurnSummary player="#{gameView.opponent}" playerClass="opponent"
                                                    isOpponent="true"/>

                                <sr:lastTurnSummary player="#{gameView.player}" playerClass="player"
                                                    isOpponent="false"/>

                                <h:panelGroup layout="block" rendered="#{!gameView.game.gameOver}" style="margin-top: 10px;"
                                              id="turnButtonsSection" styleClass="turnButtonsSection">

                                    <h:panelGroup rendered="#{gameView.player.yourTurn and empty gameView.action}">

                                        <h:panelGroup layout="block" styleClass="turnButtonWrapper"
                                                      rendered="#{gameView.showConfirmEndTurn}">
                                            <p:commandLink process="@this" update=":gameForm:gamePage"
                                                           styleClass="turnButton" value="End Turn"
                                                           onclick="if (!confirm('Are you sure you want to end your turn?')) return false"
                                                           action="#{gameView.endTurn}"/>
                                        </h:panelGroup>

                                        <h:panelGroup layout="block" styleClass="turnButtonWrapper"
                                                      rendered="#{!gameView.showConfirmEndTurn}">
                                            <sr:linkWithSpinner process="@this" update=":gameForm:gamePage"
                                                                styleClass="turnButton"
                                                                linkText="End Turn" actionMethod="#{gameView.endTurn}"/>
                                        </h:panelGroup>

                                    </h:panelGroup>

                                    <h:panelGroup layout="block" styleClass="turnButtonWrapper">
                                        <p:commandLink process="@this" styleClass="quitButton" value="Quit Game"
                                                       onclick="if (!confirm('Are you sure you want to quit the game?')) return false"
                                                       action="#{gameView.quitGame}"/>
                                    </h:panelGroup>

                                </h:panelGroup>

                                <h:panelGroup layout="block" id="cardViewSection" styleClass="cardViewSection">
                                    <h:panelGroup>
                                        <div class="cardView">
                                            <h:panelGroup layout="block" rendered="#{!empty gameView.cardToView}">
                                                <div style="padding-top: 10px;"
                                                     class="cardViewHeader #{gameView.getCardClass(gameView.cardToView)}">
                                                    <h:outputText value="#{gameView.cardToView.name}"
                                                                  style="font-weight: bold; font-size: 20px;"/>
                                                </div>

                                                <div style="padding-top: 15px; font-size: 18px;">
                                                    <h:outputText
                                                            value="#{gameView.getCardTypeString(gameView.cardToView)}"/>
                                                </div>

                                                <div style="padding-top: 15px; font-size: 18px;">
                                                    <h:outputText
                                                            value="#{gameView.getFactionDisplayName(gameView.cardToView)}"/>
                                                </div>

                                                <h:panelGroup rendered="#{!gameView.cardToView.gambit}">
                                                    <div style="padding-top: 15px;">
                                                        <h:outputText value="Cost:" style="padding-right: 10px;"/>
                                                        <h:outputText value="$#{gameView.cardToView.cost}"/>
                                                    </div>
                                                </h:panelGroup>

                                                <h:panelGroup layout="block" rendered="#{gameView.cardToView.base}"
                                                              style="padding-top: 15px;">
                                                    <h:outputText value="#{gameView.cardToView.shield} Defense"/>
                                                </h:panelGroup>

                                                <div style="padding-top: 15px;">
                                                    <h:outputText value="#{gameView.cardToView.text}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup layout="block" rendered="#{!empty gameView.missionToView}">
                                                <div style="padding-top: 10px;"
                                                     class="cardViewHeader mission">
                                                    <h:outputText value="#{gameView.missionToView.name}"
                                                                  style="font-weight: bold; font-size: 20px;"/>
                                                </div>

                                                <div style="padding-top: 15px; font-weight: bold; font-size: 16px;">
                                                    <h:outputText value="Objective:"/>
                                                </div>

                                                <div>
                                                    <h:outputText value="#{gameView.missionToView.objectiveText}"/>
                                                </div>

                                                <div style="padding-top: 15px; font-weight: bold; font-size: 16px;">
                                                    <h:outputText value="Reward:"/>
                                                </div>

                                                <div>
                                                    <h:outputText value="#{gameView.missionToView.rewardText}"/>
                                                </div>
                                            </h:panelGroup>

                                            <h:panelGroup layout="block"
                                                          rendered="#{empty gameView.cardToView and empty gameView.missionToView}"
                                                          styleClass="emptyCardView">
                                                Hover over a card to see card details.
                                            </h:panelGroup>
                                        </div>
                                    </h:panelGroup>
                                </h:panelGroup>

                            </h:panelGroup>

                        </h:panelGroup>

                    </h:panelGroup>

                </h:panelGroup>

                <h:panelGroup layout="block" id="chatSection" styleClass="chatSection" rendered="#{!gameView.opponent.bot}">
                    <h:panelGroup layout="block" style="padding-bottom: 5px;">
                        <h:outputText value="Chat" styleClass="sectionHeader"/>
                    </h:panelGroup>
                    <h:panelGroup layout="block" id="chats" class="chats">
                        <ui:repeat value="#{gameView.game.chatMessages}" var="chatMessage">
                            <h:panelGroup layout="block" style="padding-top: 10px;">
                                <h:outputText value="#{chatMessage.username}:"
                                              styleClass="#{gameView.player.playerName eq chatMessage.username ? 'player' : 'opponent'}"/>
                                <h:outputText value="#{chatMessage.message}"
                                              style="padding-left: 10px;"/>
                            </h:panelGroup>
                        </ui:repeat>
                    </h:panelGroup>
                    <h:panelGroup layout="block" style="padding-top: 10px;">
                        <p:inputText value="#{gameView.chatMessage}"
                                     style="margin-right: 10px;width: 190px"/>
                        <p:commandButton value="Send" process="chatSection" update="chatSection"
                                         actionListener="#{gameView.sendChatMessage}"
                                         oncomplete="scrollChat()"/>
                    </h:panelGroup>
                </h:panelGroup>

            </h:panelGroup>

        </h:form>

        <p:socket onMessage="handleGameMessage" channel="/game/#{gameView.game.gameId}/#{userSession.user.username}"
                  autoConnect="true" widgetVar='gameMessageSubscriber'/>

        <script type="text/javascript">
            function handleGameMessage(response) {
                console.log("received message from server: ");
                console.log(response);

                var message = response.message;

                if (message == 'refresh_game_page') {
                    refreshGamePage();
                } else if (message == 'refresh_chat') {
                    refreshChat();
                }
            }
        </script>
    </ui:define>

</ui:composition>
</html>